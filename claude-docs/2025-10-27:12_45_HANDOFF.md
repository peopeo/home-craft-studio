# Session Handoff Document
**Date:** 2025-10-27
**Time:** 12:45
**Project:** Home Craft Studio - 3D Apartment Viewer

---

## Session Overview

This session focused on implementing grid toggle functionality, fixing camera perspective issues, and implementing automatic apartment alignment. We resolved several synchronization issues with React state and Babylon.js mesh states, restored coordinate system consistency, and fixed camera projection modes.

---

## Major Achievements

### 1. Grid Toggle Functionality
- **Added:** Grid visibility toggle button in UI
- **Location:** Right panel controls (ApartmentViewer.tsx:789-804)
- **Features:**
  - Visual feedback (cyan when enabled, gray when disabled)
  - Shows "Grid (3D only)" label in Plan mode with 50% opacity
  - Tooltip explaining grid only works in 3D modes
  - Proper state management with `showGrid` React state

### 2. Grid State Synchronization Fix
- **Problem:** Grid toggle required two clicks to work after switching to 3D mode
- **Root Cause:** React StrictMode caused scene remount, resetting grid mesh to `isEnabled: false` while React state remained `true`
- **Solution:** Initialize grid state in `onSceneReady` based on current React state
- **Location:** ApartmentViewer.tsx:402-408
- **Code:**
  ```typescript
  // Initialize grid state based on current React state
  const ground = scene.getMeshByName('ground');
  if (ground) {
    const shouldEnable = viewMode !== 'plan' && showGrid;
    ground.setEnabled(shouldEnable);
  }
  ```

### 3. Z-Up Coordinate System Restoration
- **Changed From:** Y-up coordinate system (attempted in previous session)
- **Changed To:** Z-up coordinate system (original working system)
- **Reason:** Z-up was the original working configuration from commit c8edb60
- **Files Restored:**
  - `frontend/src/utils/polygonExtrusion.ts` - Reverted to Z-up vertex positioning
  - `frontend/src/components/BabylonScene.tsx` - Reverted to Z-up camera configuration
- **Key Change:**
  - Polygons: `positions.push(x, y, zOffset)` where Z is up
  - Camera: `camera.upVector = new Vector3(0, 0, 1)`
  - Normals: `(0, 0, 1)` pointing up

### 4. Floor Color Visibility Fix
- **Problem:** Floor polygons appeared white instead of colored
- **Root Cause:** Coordinate system changes inadvertently broke color rendering
- **Solution:** Restored working material setup from commit c8edb60
- **Materials:** diffuseColor + emissiveColor (50% brightness) + backFaceCulling disabled
- **No specularColor** setting (using Babylon.js defaults)

### 5. Grid Positioning and Plane Type
- **Changed:** Grid from `CreateGround` to `CreatePlane`
- **Reason:** `CreateGround` creates X-Z plane, but we need X-Y plane for Z-up
- **Position:** Moved from Z=-1.0 to Z=-0.05 for better floor-level placement
- **Location:** BabylonScene.tsx:94-106
- **Result:** Grid now properly aligned with apartment floor plane

### 6. Auto-Alignment Implementation
- **Feature:** Automatically rotate apartment to align with grid axes
- **Algorithm:**
  1. Find longest wall segment in apartment
  2. Calculate its angle relative to X-axis using `Math.atan2(dy, dx)`
  3. Rotate apartment by negative of that angle to align wall with X-axis
  4. Recalculate bounds after rotation for proper centering
- **Location:**
  - Initial load: ApartmentViewer.tsx:300-366
  - View mode switch: ApartmentViewer.tsx:670-740
- **Key Code:**
  ```typescript
  // Find the longest wall segment
  polygonData.separators.forEach(separator => {
    const coords = separator.coordinates;
    for (let i = 0; i < coords.length - 1; i++) {
      const [x1, y1] = coords[i];
      const [x2, y2] = coords[i + 1];
      const dx = x2 - x1;
      const dy = y2 - y1;
      const length = Math.sqrt(dx * dx + dy * dy);
      if (length > maxLength) {
        maxLength = length;
        dominantAngle = Math.atan2(dy, dx);
      }
    }
  });

  // Use exact angle (no snapping)
  rotationAngle = -dominantAngle;
  apartmentRoot.rotation.z = rotationAngle;
  ```

### 7. Perspective Camera Mode Fix
- **Problem:** Perspective mode showed orthographic projection (no depth perspective)
- **Root Cause:** `Camera.PERSPECTIVE_CAMERA` constant imported incorrectly, returned 0 instead of 1
- **Solution:** Use numeric values directly
  - `0` = Orthographic mode
  - `1` = Perspective mode
- **Locations Changed:**
  - ApartmentViewer.tsx:592, 607, 623
  - BabylonScene.tsx:54, 70
- **FOV Added:** `camera.fov = 0.8` (~45.8 degrees) for proper perspective
- **Result:** Perspective mode now shows true depth perspective (far objects smaller than near)

### 8. Plan Mode Camera Angle Adjustment
- **Changed:** `camera.beta` from `0.1` (5.7Â°) to `0.001` (0.057Â°)
- **Reason:** 0.1 radians created noticeable tilt, making blue Z-axis lean backward
- **Location:**
  - BabylonScene.tsx:40
  - ApartmentViewer.tsx:602
- **Result:** Nearly perfect top-down view with imperceptible tilt to avoid gimbal lock

---

## Technical Implementation Details

### Coordinate System: Z-Up

**Convention:** Right-handed, Z-up
- **X-axis:** Right (red)
- **Y-axis:** Forward (green)
- **Z-axis:** Up (blue) - extrusion direction

**Floor plane:** X-Y plane (horizontal)
**Vertical axis:** Z-axis

**Polygon vertex positions:**
```typescript
// 2D polygons (floors)
coordinates.forEach(([x, y]) => {
  positions.push(x, y, zOffset); // Z is vertical offset
});

// 3D extrusion (walls)
// Bottom vertices at elevation
coordinates.forEach(([x, y]) => {
  positions.push(x, y, elevation); // Z is base height
});
// Top vertices at elevation + height
coordinates.forEach(([x, y]) => {
  positions.push(x, y, elevation + height); // Z is top height
});
```

### Camera Modes

**Plan Mode:**
- Mode: `0` (Orthographic)
- Alpha: `-Ï€/2` (looking from front)
- Beta: `0.001` (nearly top-down, avoiding gimbal lock)
- Ortho bounds: Aspect ratio corrected
- Grid: Hidden

**Isometric Mode:**
- Mode: `0` (Orthographic)
- Alpha: `-Ï€/4` (45Â° horizontal)
- Beta: `Ï€/3` (60Â° from top)
- Ortho bounds: Aspect ratio corrected
- Grid: Shown if enabled

**Perspective Mode:**
- Mode: `1` (Perspective)
- FOV: `0.8` radians (~45.8Â°)
- Alpha: `-Ï€/4` (45Â° horizontal)
- Beta: `Ï€/3` (60Â° from top)
- Grid: Shown if enabled

### Grid Configuration

```typescript
const ground = MeshBuilder.CreatePlane('ground', { width: 50, height: 50 }, scene);
// No rotation needed - CreatePlane makes X-Y plane by default
gridMaterial.majorUnitFrequency = 5;
gridMaterial.minorUnitVisibility = 0.45;
gridMaterial.gridRatio = 1;
ground.position.z = -0.05; // Slightly below floor (Z=0)
ground.isPickable = false;
ground.setEnabled(false); // Start hidden
```

### Auto-Alignment Algorithm

1. **Find dominant wall direction** by iterating all separator (wall) segments
2. **Select longest segment** as representative of building orientation
3. **Calculate angle** using `Math.atan2(dy, dx)` (range: -Ï€ to Ï€)
4. **Apply rotation** `apartmentRoot.rotation.z = -dominantAngle`
5. **Recompute bounds** using world space coordinates after rotation
6. **Recenter apartment** based on new bounds

**No snapping** - uses exact angle for precise alignment

---

## File Changes Summary

### Modified Files

**1. `frontend/src/components/ApartmentViewer.tsx`**
- Added `showGrid` state and `toggleGrid` callback
- Added grid toggle button UI
- Restored Z-up coordinate system in apartment positioning
- Implemented auto-alignment algorithm (2 locations: initial + view switch)
- Fixed camera mode to use numeric values (0/1) instead of constants
- Adjusted Plan mode camera beta to 0.001
- Added grid state initialization in `onSceneReady`
- Added comprehensive debug logging

**2. `frontend/src/components/BabylonScene.tsx`**
- Restored Z-up coordinate system
- Changed grid from `CreateGround` to `CreatePlane`
- Moved grid position from Z=-1.0 to Z=-0.05
- Added FOV setting for perspective mode
- Changed camera mode values to numeric (0/1)
- Adjusted initial camera beta to 0.001

**3. `frontend/src/utils/polygonExtrusion.ts`**
- Restored Z-up coordinate system
- Vertex positions: `(x, y, z)` where Z is vertical
- Normals: `(0, 0, 1)` pointing up

### New Files
- `claude-docs/2025-10-27:12_45_HANDOFF.md` (this file)

### Commit
- **Hash:** `eb43e41`
- **Message:** "Add grid toggle and auto-alignment features"
- **Stats:** 6 files changed, +276 insertions, -336 deletions

---

## Known Issues & Limitations

### None Currently
All major issues from this session have been resolved:
- âœ… Grid toggle works on first click
- âœ… Perspective mode shows true depth perspective
- âœ… Floor colors display correctly
- âœ… Grid aligns with floor plane
- âœ… Apartment auto-aligns to grid axes
- âœ… Plan mode shows nearly perfect top-down view
- âœ… React StrictMode doesn't break grid state

---

## Running the Application

### Backend
```bash
cd /home/peo/pogonal/labor/home-craft-studio
conda activate home-craft-studio
cd backend
/home/peo/anaconda3/envs/home-craft-studio/bin/uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
```

### Frontend
```bash
cd /home/peo/pogonal/labor/home-craft-studio/frontend
npm run dev
```

**Access:** http://localhost:5173

---

## Git Repository

**GitHub:** https://github.com/peopeo/home-craft-studio.git
**Branch:** master
**Status:** 1 commit ahead of origin/master (unpushed)

**Latest Commits:**
- `eb43e41` - Add grid toggle and auto-alignment features (unpushed)
- `629b500` - Add session handoff documentation
- `c8edb60` - Keep room areas flat as floor polygons in 3D modes

**To push:**
```bash
git push
```

---

## UI Controls

### View Mode Buttons (Right Panel)
- **ðŸ“ Perspective** - 3D view with perspective projection (depth perspective)
- **ðŸ“ Isometric** - 3D view with orthographic projection (no depth)
- **ðŸ“‹ Plan (2D)** - Top-down 2D floor plan

### Camera View Buttons (Right Panel)
- Top, Bottom, Front, Left, Right, 3D View (Isometric)

### Visibility Toggles (Right Panel)
- Walls
- Doors
- Windows
- Rotation Gizmo
- 3D Axes
- **Grid** - Toggle grid visibility (only works in 3D modes)

### Mouse Controls
- **Scroll wheel:** Zoom in/out
- **Left drag:** Rotate camera (3D modes)
- **Right drag:** Pan camera
- **Click:** Select element (shows metadata in bottom-left panel)

---

## Color Scheme

### Areas (Rooms)
- BATHROOM: Light blue (0.7, 0.85, 1)
- LIVING_ROOM: Light yellow (1, 1, 0.7)
- KITCHEN: Light red (1, 0.8, 0.8)
- BEDROOM/ROOM: Light green (0.8, 1, 0.8)
- BALCONY: Light purple (0.9, 0.85, 1)
- CORRIDOR: Light gray (0.9, 0.9, 0.9)
- LOGGIA: Light cyan (0.85, 0.9, 1)
- STOREROOM: Beige (0.95, 0.9, 0.85)
- SHAFT: Gray (0.8, 0.8, 0.8)

### Separators
- WALL: Dark gray (0.3, 0.3, 0.3)

### Openings
- WINDOW: White (1, 1, 1) - 80% opacity, self-lit
- DOOR: Brown (0.6, 0.4, 0.2) - 100% opacity, self-lit
- ENTRANCE_DOOR: Dark brown (0.5, 0.3, 0.1) - 100% opacity, self-lit

**All colors have 50% emissive brightness** for consistent appearance.

---

## Dependencies

### Frontend
```json
{
  "@babylonjs/core": "^8.33.2",
  "@babylonjs/materials": "^8.33.2",
  "earcut": "^2.2.4",
  "react": "^18.3.1",
  "typescript": "^5.6.3",
  "vite": "^6.0.3"
}
```

### Backend
```
fastapi==0.120.0
uvicorn
pandas==2.3.3
shapely==2.1.2
pygltflib==1.16.5
```

---

## Important Notes for Next Session

### Environment Setup
- **Python environment:** `home-craft-studio` (conda)
- **Working directory:** `/home/peo/pogonal/labor/home-craft-studio`
- **Data file location:** Project root (excluded via .gitignore)
- **Backend runs on:** http://localhost:8000
- **Frontend runs on:** http://localhost:5173

### Key Architecture Decisions

1. **Z-up coordinate system** - Do not change to Y-up, Z-up is the working system
2. **Numeric camera modes** - Use `0` and `1` directly, not `Camera.ORTHOGRAPHIC_CAMERA` constants
3. **CreatePlane for grid** - Not CreateGround, because we need X-Y plane
4. **Grid position Z=-0.05** - Close enough to floor to see, far enough to avoid z-fighting
5. **Auto-alignment** - Uses exact angle from longest wall, no snapping
6. **Beta = 0.001** - Small non-zero value to avoid gimbal lock in Plan mode
7. **FOV = 0.8** - Required for perspective mode to work properly
8. **Grid state sync** - Must initialize in `onSceneReady` due to React StrictMode remounting

### Code Patterns to Follow

**Camera mode setting:**
```typescript
camera.mode = 0; // Orthographic
camera.mode = 1; // Perspective
```

**Grid initialization:**
```typescript
// In onSceneReady, AFTER all mesh creation
const ground = scene.getMeshByName('ground');
if (ground) {
  const shouldEnable = viewMode !== 'plan' && showGrid;
  ground.setEnabled(shouldEnable);
}
```

**Auto-alignment:**
```typescript
// Find longest wall segment
let maxLength = 0;
let dominantAngle = 0;
// ... iterate separators ...
const length = Math.sqrt(dx * dx + dy * dy);
if (length > maxLength) {
  maxLength = length;
  dominantAngle = Math.atan2(dy, dx);
}
// Apply exact rotation (no snapping)
rotationAngle = -dominantAngle;
apartmentRoot.rotation.z = rotationAngle;
```

---

## Debugging Tips

### Common Issues

**Grid toggle not working:**
- Check if React StrictMode is causing double-mount
- Verify grid state is initialized in `onSceneReady`
- Confirm `ground.isEnabled()` matches React `showGrid` state

**Perspective still looks orthographic:**
- Verify `camera.mode === 1` (not 0)
- Check `camera.fov` is set (should be ~0.8)
- Console log camera.mode after switching

**Floor colors wrong:**
- Don't set `specularColor` (use Babylon.js defaults)
- Ensure both `diffuseColor` and `emissiveColor` are set
- emissiveColor should be color.scale(0.5) for 50% brightness

**Apartment misaligned:**
- Check auto-alignment console logs for rotation angle
- Verify longest wall is being found correctly
- Confirm rotation is applied before centering

**Plan mode tilted:**
- Beta should be 0.001, not 0.1
- Check both initial camera setup and view mode switch

---

## Testing Checklist

After making changes, verify:
- [ ] Grid toggle works on first click when switching to Perspective/Isometric
- [ ] Grid button dims (50% opacity) in Plan mode
- [ ] Grid shows in Perspective and Isometric (if enabled)
- [ ] Grid hidden in Plan mode (always)
- [ ] Perspective mode: far edges appear smaller than near edges
- [ ] Isometric mode: all parallel lines stay parallel (no perspective)
- [ ] Plan mode: nearly perfect top-down view (blue axis straight up)
- [ ] Floor colors match room types (blue bathroom, yellow living room, etc.)
- [ ] Auto-alignment: apartment walls align with red/green grid axes
- [ ] Console logs show rotation angle applied during alignment
- [ ] All three view modes can be switched without errors
- [ ] Camera controls (pan, zoom, rotate) work in all modes

---

## Session Statistics

**Duration:** ~3 hours
**Files Modified:** 3
**Lines Changed:** +276/-336
**Commits:** 1 (unpushed)
**Issues Resolved:** 8 major issues
- Grid toggle implementation
- Grid state synchronization (React StrictMode)
- Z-up coordinate system restoration
- Floor color visibility
- Grid plane alignment
- Auto-alignment implementation
- Perspective camera mode fix
- Plan mode camera angle adjustment

---

## Contact & Resources

**Project Repository:** https://github.com/peopeo/home-craft-studio
**Babylon.js Docs:** https://doc.babylonjs.com/
**Babylon.js Camera:** https://doc.babylonjs.com/features/featuresDeepDive/cameras/camera_introduction
**Earcut Library:** https://github.com/mapbox/earcut
**FastAPI Docs:** https://fastapi.tiangolo.com/

---

*Document generated: 2025-10-27 12:45*
*Next session: Continue from master branch, all features working, 1 commit unpushed*
