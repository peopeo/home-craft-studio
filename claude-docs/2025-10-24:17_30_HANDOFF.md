# Session Handoff Document
**Date:** 2025-10-24
**Time:** 17:30
**Project:** Home Craft Studio - 3D Apartment Viewer

---

## Session Overview

This session implemented a complete frontend polygon extrusion system with multiple 3D view modes for the apartment viewer application. We transitioned from loading pre-generated GLB files to performing real-time polygon extrusion on the frontend using Babylon.js.

---

## Major Achievements

### 1. Frontend Polygon Extrusion System
- **Created:** `frontend/src/utils/polygonExtrusion.ts`
- **Purpose:** Manual 3D geometry generation from 2D polygon coordinates
- **Key Functions:**
  - `create2DPolygon()` - Flat polygons for Plan view and floor surfaces
  - `create3DExtrudedPolygon()` - 3D extruded meshes for walls/openings
  - `getColorForType()` - Color mapping for different element types
  - `getAlphaForType()` - Transparency settings (windows at 80%)

### 2. Three View Modes Implementation
Implemented in `ApartmentViewer.tsx`:
- **Plan Mode**: 2D orthographic top-down view (initial default)
- **Perspective Mode**: 3D view with perspective projection
- **Isometric Mode**: 3D view with orthographic projection

### 3. Backend Polygon Endpoint
- **Added:** `/apartment/{apartment_id}/polygons` endpoint in `backend/app/main.py`
- **Returns:** JSON with polygon coordinates, elevations, and heights
- **Structure:**
  ```json
  {
    "apartment_id": "string",
    "areas": [...],      // Room floor polygons
    "separators": [...], // Walls
    "openings": [...]    // Doors and windows
  }
  ```

### 4. Camera System Improvements
- Fixed orthographic camera aspect ratio handling
- Custom mouse wheel zoom for orthographic modes
- Proper viewport scaling to prevent stretching artifacts
- Camera controls: wheel zoom, left-drag rotate, right-drag pan

### 5. Visual Enhancements
- Self-illuminating materials (emissive colors) for all elements
- Windows: white, 80% opacity, self-lit
- Doors: brown, 100% opacity, self-lit
- Rooms/Walls: colored with 50% emissive brightness
- Z-layering in 2D mode: areas (0), walls (0.001), openings (0.002)

---

## Technical Implementation Details

### Geometry Building Approach

**Initial Problem:** Babylon.js `ExtrudePolygon()` works in XOZ plane and extrudes along Y-axis, but our coordinate system uses Z-up.

**Solution:** Manual geometry construction directly in Z-up orientation:
1. Triangulate 2D polygon using earcut
2. Create bottom face vertices at `elevation`
3. Create top face vertices at `elevation + height`
4. Generate side wall triangles connecting bottom and top
5. Compute normals automatically

**Key Code (polygonExtrusion.ts:69-156):**
```typescript
// Bottom face vertices (at elevation)
coordinates.forEach(([x, y]) => {
  positions.push(x, y, elevation);
});

// Top face vertices (at elevation + height)
coordinates.forEach(([x, y]) => {
  positions.push(x, y, elevation + height);
});

// Side faces
for (let i = 0; i < numVertices; i++) {
  const next = (i + 1) % numVertices;
  indices.push(i, next, i + numVertices);
  indices.push(next, next + numVertices, i + numVertices);
}
```

### Rendering Strategy by View Mode

**Plan Mode (2D):**
- All elements rendered as flat polygons at Z=0
- Grid hidden to avoid obscuring floor plan
- Z-layering for proper selection: areas â†’ walls â†’ openings

**3D Modes (Perspective/Isometric):**
- **Areas (rooms):** Flat polygons at elevation (floor surfaces)
- **Separators (walls):** Extruded from elevation to elevation+height
- **Openings (doors/windows):** Extruded with proper heights
- Grid shown as reference plane at Z=-0.5

### Camera Configuration

**Orthographic Mode (BabylonScene.tsx:50-57, 65-87):**
```typescript
camera.mode = Camera.ORTHOGRAPHIC_CAMERA;
const aspectRatio = engine.getRenderWidth() / engine.getRenderHeight();
camera.orthoLeft = -size * aspectRatio;
camera.orthoRight = size * aspectRatio;
camera.orthoBottom = -size;
camera.orthoTop = size;
```

**Custom Zoom Handler:**
- Prevents default wheel behavior
- Scales ortho bounds by 10% per scroll
- Maintains aspect ratio
- Clamps zoom range: 2-100 units

---

## File Changes Summary

### New Files
- `frontend/src/utils/polygonExtrusion.ts` (182 lines)
- `claude-docs/2025-10-24:17_30_HANDOFF.md` (this file)

### Modified Files
- `frontend/src/components/ApartmentViewer.tsx` (851 lines)
  - Added view mode state management
  - Implemented `renderApartment()` with conditional 2D/3D rendering
  - Added `setViewModeAndCamera()` for mode switching
  - Removed debug markers

- `frontend/src/components/BabylonScene.tsx` (120 lines)
  - Added aspect ratio calculations
  - Custom wheel event handler for ortho zoom
  - Initial camera setup for Plan mode

- `backend/app/main.py` (154 lines)
  - Added `/apartment/{apartment_id}/polygons` endpoint

- `frontend/package.json` & `frontend/package-lock.json`
  - Added `earcut: ^2.2.4` dependency

### Deleted Files
- Old screenshots and debug images
- Temporary view testing screenshots

---

## Dependencies

### Frontend
```json
{
  "@babylonjs/core": "^8.33.2",
  "@babylonjs/materials": "^8.33.2",
  "earcut": "^2.2.4",
  "react": "^18.3.1",
  "typescript": "^5.6.3",
  "vite": "^6.0.3"
}
```

### Backend
```
fastapi
uvicorn
pandas
shapely
pygltflib
```

---

## Known Issues & Limitations

### None Currently
All major issues resolved during this session:
- âœ… Fixed flat geometry issue (was using wrong extrusion axis)
- âœ… Fixed stretching artifacts (aspect ratio problem)
- âœ… Fixed grid interference in Plan mode
- âœ… Fixed window visibility (emissive colors)
- âœ… Fixed transformation conflicts (manual geometry building)

---

## Running the Application

### Backend
```bash
cd /home/peo/pogonal/labor/home-craft-studio
conda activate home-craft-studio
cd backend
/home/peo/anaconda3/envs/home-craft-studio/bin/uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
```

### Frontend
```bash
cd /home/peo/pogonal/labor/home-craft-studio/frontend
npm run dev
```

**Access:** http://localhost:5173

---

## Git Repository

**GitHub:** https://github.com/peopeo/home-craft-studio.git
**Branch:** master (only branch, feature branch deleted after merge)
**Latest Commits:**
- `c8edb60` - Keep room areas flat as floor polygons in 3D modes
- `c48601c` - Implement frontend 3D extrusion with multiple view modes
- `572c5fd` - Initial commit

---

## UI Controls

### View Mode Buttons (Right Panel)
- **ðŸ“ Perspective** - 3D view with perspective projection
- **ðŸ“ Isometric** - 3D view with orthographic projection
- **ðŸ“‹ Plan (2D)** - Top-down 2D floor plan

### Camera View Buttons (Right Panel)
- Top, Bottom, Front, Left, Right, 3D View (Isometric)

### Visibility Toggles (Right Panel)
- Walls, Doors, Windows, Rotation Gizmo, 3D Axes

### Mouse Controls
- **Scroll wheel:** Zoom in/out
- **Left drag:** Rotate camera (3D modes)
- **Right drag:** Pan camera
- **Click:** Select element (shows metadata in bottom-left panel)

---

## Color Scheme

### Areas (Rooms)
- BATHROOM: Light blue (0.7, 0.85, 1)
- LIVING_ROOM: Light yellow (1, 1, 0.7)
- KITCHEN: Light red (1, 0.8, 0.8)
- BEDROOM/ROOM: Light green (0.8, 1, 0.8)
- BALCONY: Light purple (0.9, 0.85, 1)
- CORRIDOR: Light gray (0.9, 0.9, 0.9)
- LOGGIA: Light cyan (0.85, 0.9, 1)
- STOREROOM: Beige (0.95, 0.9, 0.85)

### Separators
- WALL: Dark gray (0.3, 0.3, 0.3)

### Openings
- WINDOW: White (1, 1, 1) - 80% opacity, self-lit
- DOOR: Brown (0.6, 0.4, 0.2) - 100% opacity, self-lit
- ENTRANCE_DOOR: Dark brown (0.5, 0.3, 0.1) - 100% opacity, self-lit

**All colors have 50% emissive brightness** (self-illuminating) for consistent appearance regardless of scene lighting.

---

## Coordinate System

**Convention:** Z-up, right-handed
- **X-axis:** Right (red)
- **Y-axis:** Forward (green)
- **Z-axis:** Up (blue) - extrusion direction

**Ground level:** Z = 0
**Grid plane:** Z = -0.5 (renders behind everything)

---

## Data Flow

```
CSV File (mds_V2_5.372k.csv)
    â†“
Backend: ApartmentDataExtractor
    â†“
API: /apartment/{id}/polygons
    â†“
Frontend: fetch polygon data
    â†“
polygonExtrusion.ts: create2DPolygon() or create3DExtrudedPolygon()
    â†“
ApartmentViewer: renderApartment()
    â†“
Babylon.js Scene: render with camera/materials
    â†“
User sees 3D apartment view
```

---

## Next Steps / Future Enhancements

### Potential Features
1. **Furniture Placement:** Add ability to place and move furniture
2. **Measurement Tool:** Click to measure distances between points
3. **Material Editor:** Allow users to change colors/materials
4. **Export Functionality:** Export modified apartments as GLB/GLTF
5. **Multiple Apartments:** Load and compare multiple apartments side-by-side
6. **Floor Selection:** If data has multiple floors, add floor selector
7. **Lighting Controls:** Adjust ambient/directional lighting
8. **Shadow Rendering:** Enable shadow mapping for more realistic 3D
9. **VR/AR Mode:** Add WebXR support for immersive viewing
10. **Performance:** LOD (Level of Detail) system for large buildings

### Technical Improvements
1. **Caching:** Cache generated meshes to avoid regeneration on view switch
2. **Web Workers:** Move polygon processing to worker threads
3. **Compression:** Compress polygon data transfer
4. **Progressive Loading:** Load apartments incrementally
5. **Tests:** Add unit tests for geometry generation
6. **Documentation:** JSDoc comments for all functions

---

## Important Notes for Next Session

### Environment Setup
- **Python environment:** `home-craft-studio` (conda)
- **Working directory:** `/home/peo/pogonal/labor/home-craft-studio`
- **Data file location:** Project root (excluded via .gitignore)
- **Backend runs on:** http://localhost:8000
- **Frontend runs on:** http://localhost:5173

### Key Architecture Decisions
1. **No rotation transformations:** Geometry built directly in Z-up to avoid matrix conflicts
2. **Areas always flat:** Floor polygons never extruded, even in 3D modes
3. **Emissive colors everywhere:** Makes lighting-independent appearance
4. **Aspect ratio critical:** Must maintain for orthographic cameras
5. **Z-layering in 2D:** Small offsets (0.001) ensure proper rendering order

### Code Patterns to Follow
- Always use `create2DPolygon()` for floors
- Always use `create3DExtrudedPolygon()` for vertical elements (walls, openings)
- Always set `material.emissiveColor` for consistent brightness
- Always compute aspect ratio when setting ortho bounds
- Always make meshes double-sided: `mesh.sideOrientation = Mesh.DOUBLESIDE`

---

## Debugging Tips

### Common Issues

**Meshes appear flat when they should be 3D:**
- Check that `create3DExtrudedPolygon()` is being called, not `create2DPolygon()`
- Verify height values in data are non-zero

**Stretching when rotating camera:**
- Check aspect ratio is being calculated and applied to ortho bounds
- Ensure orthoLeft/Right use `size * aspectRatio`, orthoBottom/Top use just `size`

**Elements not visible:**
- Check emissive color is set (makes material self-lit)
- Verify Z-position isn't below grid (Z < -0.5)
- Check material alpha isn't 0

**Selection not working:**
- Ensure metadata is attached to mesh
- Check mesh.isPickable is true (default)
- Verify ground plane has `isPickable = false`

**Colors too dark:**
- Increase emissive color scale (currently 0.5)
- Add more scene lighting

---

## Session Statistics

**Duration:** ~6 hours
**Files Created:** 2
**Files Modified:** 4
**Lines Added:** ~913
**Lines Removed:** ~233
**Commits:** 2
**Issues Resolved:** 8 major issues

---

## Contact & Resources

**Project Repository:** https://github.com/peopeo/home-craft-studio
**Babylon.js Docs:** https://doc.babylonjs.com/
**Earcut Library:** https://github.com/mapbox/earcut
**FastAPI Docs:** https://fastapi.tiangolo.com/

---

*Document generated: 2025-10-24 17:30*
*Next session: Continue from master branch, all features working*
